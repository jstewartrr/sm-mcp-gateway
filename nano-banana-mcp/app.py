"""
Nano Banana MCP Server - HTTP Transport for Claude.ai
Provides Gemini 2.5 Flash Image and Gemini 2.5 Pro Image generation
Fixed version using google-genai SDK with response_modalities
"""

import os
import json
import base64
import logging
from typing import Any, Dict, List
from flask import Flask, request, jsonify, Response
import queue
import uuid

from google import genai
from google.genai.types import GenerateContentConfig, Part

# Configure logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Initialize Flask app
app = Flask(__name__)

# Initialize Vertex AI client
PROJECT_ID = os.environ.get("GOOGLE_CLOUD_PROJECT", "innate-concept-481918-h9")
LOCATION = os.environ.get("GOOGLE_CLOUD_LOCATION", "us-central1")

try:
    client = genai.Client(
        vertexai=True,
        project=PROJECT_ID,
        location=LOCATION
    )
    logger.info(f"Vertex AI client initialized for project {PROJECT_ID}")
except Exception as e:
    logger.error(f"Failed to initialize Vertex AI client: {e}")
    client = None


# Tool definitions
TOOLS = [
    {
        "name": "nano_banana_generate",
        "description": "Generate images using Gemini 2.5 Flash Image (Nano Banana). Best for infographics, diagrams, slides, and visual content. Returns base64-encoded image.",
        "inputSchema": {
            "type": "object",
            "properties": {
                "prompt": {
                    "type": "string",
                    "description": "Text description of image to generate"
                },
                "aspect_ratio": {
                    "type": "string",
                    "enum": ["1:1", "16:9", "9:16", "4:3", "3:4", "3:2", "2:3"],
                    "default": "16:9"
                },
                "style": {
                    "type": "string",
                    "description": "Style hint: corporate, minimal, bold, creative",
                    "default": "corporate"
                }
            },
            "required": ["prompt"]
        }
    },
    {
        "name": "nano_banana_pro_generate",
        "description": "Generate images using Gemini 2.5 Pro Image (Nano Banana Pro). Superior for complex infographics, accurate text rendering, diagrams with world knowledge. Returns base64-encoded image.",
        "inputSchema": {
            "type": "object",
            "properties": {
                "prompt": {
                    "type": "string",
                    "description": "Text description of image to generate"
                },
                "aspect_ratio": {
                    "type": "string",
                    "enum": ["1:1", "16:9", "9:16", "4:3", "3:4", "3:2", "2:3"],
                    "default": "16:9"
                },
                "style": {
                    "type": "string",
                    "description": "Style hint: corporate, minimal, bold, creative",
                    "default": "corporate"
                }
            },
            "required": ["prompt"]
        }
    },
    {
        "name": "nano_banana_edit",
        "description": "Edit an existing image using Nano Banana. Provide base64 image and edit instructions.",
        "inputSchema": {
            "type": "object",
            "properties": {
                "image_base64": {
                    "type": "string",
                    "description": "Base64-encoded source image"
                },
                "prompt": {
                    "type": "string",
                    "description": "Edit instructions"
                }
            },
            "required": ["image_base64", "prompt"]
        }
    }
]


def generate_image(prompt: str, model_name: str, aspect_ratio: str = "16:9", style: str = "corporate") -> Dict[str, Any]:
    """Generate an image using Gemini's native image generation."""
    if not client:
        return {"error": "Vertex AI client not initialized"}
    
    try:
        # Enhance prompt with style hints
        enhanced_prompt = f"""Create a professional {style} style image:
{prompt}

Style guidelines:
- Clean, modern design
- Professional color palette
- High contrast and readability
- Suitable for business presentations
Aspect ratio: {aspect_ratio}"""

        # Use the correct model and config for image generation
        response = client.models.generate_content(
            model=model_name,
            contents=enhanced_prompt,
            config=GenerateContentConfig(
                response_modalities=["IMAGE", "TEXT"],
                temperature=0.7,
            )
        )
        
        # Extract the image from response
        for part in response.candidates[0].content.parts:
            if hasattr(part, 'inline_data') and part.inline_data:
                image_data = part.inline_data.data
                mime_type = part.inline_data.mime_type
                
                # Encode to base64 if not already
                if isinstance(image_data, bytes):
                    image_base64 = base64.b64encode(image_data).decode('utf-8')
                else:
                    image_base64 = image_data
                    
                return {
                    "success": True,
                    "image_base64": image_base64,
                    "mime_type": mime_type,
                    "model": model_name
                }
        
        # If no image found, return text response
        text_parts = [part.text for part in response.candidates[0].content.parts if hasattr(part, 'text')]
        return {
            "success": False,
            "error": "No image generated",
            "text_response": " ".join(text_parts) if text_parts else "No response"
        }
        
    except Exception as e:
        logger.error(f"Image generation error: {e}")
        return {"error": str(e)}


def edit_image(image_base64: str, prompt: str) -> Dict[str, Any]:
    """Edit an image using Gemini."""
    if not client:
        return {"error": "Vertex AI client not initialized"}
    
    try:
        # Decode the input image
        image_bytes = base64.b64decode(image_base64)
        
        # Create the edit request
        response = client.models.generate_content(
            model="gemini-2.0-flash-exp",
            contents=[
                Part.from_bytes(data=image_bytes, mime_type="image/png"),
                f"Edit this image: {prompt}"
            ],
            config=GenerateContentConfig(
                response_modalities=["IMAGE", "TEXT"],
                temperature=0.7,
            )
        )
        
        # Extract the edited image
        for part in response.candidates[0].content.parts:
            if hasattr(part, 'inline_data') and part.inline_data:
                image_data = part.inline_data.data
                mime_type = part.inline_data.mime_type
                
                if isinstance(image_data, bytes):
                    image_base64_out = base64.b64encode(image_data).decode('utf-8')
                else:
                    image_base64_out = image_data
                    
                return {
                    "success": True,
                    "image_base64": image_base64_out,
                    "mime_type": mime_type
                }
        
        return {"success": False, "error": "No edited image returned"}
        
    except Exception as e:
        logger.error(f"Image edit error: {e}")
        return {"error": str(e)}


def call_tool(name: str, arguments: Dict[str, Any]) -> Dict[str, Any]:
    """Execute a tool by name."""
    
    if name == "nano_banana_generate":
        return generate_image(
            prompt=arguments.get("prompt", ""),
            model_name="gemini-2.0-flash-exp",  # Flash for speed
            aspect_ratio=arguments.get("aspect_ratio", "16:9"),
            style=arguments.get("style", "corporate")
        )
    
    elif name == "nano_banana_pro_generate":
        return generate_image(
            prompt=arguments.get("prompt", ""),
            model_name="gemini-2.5-pro-preview-06-05",  # Pro for quality
            aspect_ratio=arguments.get("aspect_ratio", "16:9"),
            style=arguments.get("style", "corporate")
        )
    
    elif name == "nano_banana_edit":
        return edit_image(
            image_base64=arguments.get("image_base64", ""),
            prompt=arguments.get("prompt", "")
        )
    
    else:
        return {"error": f"Unknown tool: {name}"}


# SSE message queues for each session
sse_queues: Dict[str, queue.Queue] = {}


@app.route("/", methods=["GET"])
def health():
    """Health check endpoint."""
    return jsonify({
        "status": "healthy",
        "service": "nano-banana-mcp",
        "version": "1.0.0",
        "project": PROJECT_ID,
        "client_initialized": client is not None
    })


@app.route("/sse", methods=["GET"])
def sse_connect():
    """SSE endpoint for MCP connection."""
    session_id = str(uuid.uuid4())
    sse_queues[session_id] = queue.Queue()
    
    def generate():
        # Send initial endpoint message
        endpoint_msg = {
            "jsonrpc": "2.0",
            "method": "endpoint",
            "params": {"uri": f"/messages?session_id={session_id}"}
        }
        yield f"data: {json.dumps(endpoint_msg)}\n\n"
        
        # Keep connection alive and send queued messages
        while True:
            try:
                msg = sse_queues[session_id].get(timeout=30)
                yield f"data: {json.dumps(msg)}\n\n"
            except queue.Empty:
                yield ": keepalive\n\n"
    
    return Response(generate(), mimetype="text/event-stream")


@app.route("/messages", methods=["POST"])
def handle_message():
    """Handle MCP messages."""
    session_id = request.args.get("session_id")
    data = request.get_json()
    
    method = data.get("method", "")
    msg_id = data.get("id")
    
    if method == "initialize":
        response = {
            "jsonrpc": "2.0",
            "id": msg_id,
            "result": {
                "protocolVersion": "2024-11-05",
                "serverInfo": {
                    "name": "nano-banana-mcp",
                    "version": "1.0.0"
                },
                "capabilities": {
                    "tools": {"listChanged": False}
                }
            }
        }
    
    elif method == "tools/list":
        response = {
            "jsonrpc": "2.0",
            "id": msg_id,
            "result": {"tools": TOOLS}
        }
    
    elif method == "tools/call":
        tool_name = data.get("params", {}).get("name", "")
        arguments = data.get("params", {}).get("arguments", {})
        
        result = call_tool(tool_name, arguments)
        
        response = {
            "jsonrpc": "2.0",
            "id": msg_id,
            "result": {
                "content": [
                    {"type": "text", "text": json.dumps(result)}
                ]
            }
        }
    
    elif method == "notifications/initialized":
        return "", 204
    
    else:
        response = {
            "jsonrpc": "2.0",
            "id": msg_id,
            "error": {"code": -32601, "message": f"Method not found: {method}"}
        }
    
    # Queue response for SSE if session exists
    if session_id and session_id in sse_queues:
        sse_queues[session_id].put(response)
    
    return jsonify(response)


if __name__ == "__main__":
    port = int(os.environ.get("PORT", 8080))
    app.run(host="0.0.0.0", port=port, debug=False)
